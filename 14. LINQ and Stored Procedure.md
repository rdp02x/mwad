# 14. LINQ and Stored Procedure

> [Perform this application using LINQ and Stored Procedure]
> Create database `train_master` having table `train_info` and have fields like `train_id` (PK, AI), `train_name`, `train_type`, `arrival_time`, `departure_time`, `start_location`, `end _location`. 
> Create web page `traindata.aspx` that allow user to enter ***train_id***, ***train_name***, ***train_type***, ***arrival_time***, ***departure_time***, ***start_location***, ***end_location*** and perform following operations:
> - Insert 
> - Delete
> - View 
> - Update 
> - Search 

### 1) SQL: Database, Table & Stored Procedures

```sql
CREATE DATABASE train_master;
```

```sql
USE train_master;
```

```sql
CREATE TABLE train_info (
  train_id INT IDENTITY(1, 1) PRIMARY KEY, 
  train_name NVARCHAR(100), 
  train_type NVARCHAR(50), 
  arrival_time TIME, 
  departure_time TIME, 
  start_location NVARCHAR(100), 
  end_location NVARCHAR(100)
);
```

```sql
-- Insert

CREATE PROC sp_InsertTrain @train_name NVARCHAR(100), 
@train_type NVARCHAR(50), 
@arrival_time TIME, 
@departure_time TIME, 
@start_location NVARCHAR(100), 
@end_location NVARCHAR(100) AS INSERT INTO train_info 
VALUES 
  (
    @train_name, @train_type, @arrival_time, 
    @departure_time, @start_location, 
    @end_location
  );
```

```sql
-- Update

CREATE PROC sp_UpdateTrain @train_id INT, 
@train_name NVARCHAR(100), 
@train_type NVARCHAR(50), 
@arrival_time TIME, 
@departure_time TIME, 
@start_location NVARCHAR(100), 
@end_location NVARCHAR(100) AS 
UPDATE 
  train_info 
SET 
  train_name = @train_name, 
  train_type = @train_type, 
  arrival_time = @arrival_time, 
  departure_time = @departure_time, 
  start_location = @start_location, 
  end_location = @end_location 
WHERE 
  train_id = @train_id;
```

```sql
-- Delete

CREATE PROC sp_DeleteTrain @train_id INT AS 
DELETE FROM 
  train_info 
WHERE 
  train_id = @train_id;
```

```sql
-- View

CREATE PROC sp_GetTrains AS 
SELECT 
  * 
FROM 
  train_info;
```

```sql
-- Search 

CREATE PROC sp_SearchTrain @keyword NVARCHAR(100) AS 
SELECT 
  * 
FROM 
  train_info 
WHERE 
  train_name LIKE '%' + @keyword + '%' 
  OR train_type LIKE '%' + @keyword + '%';
```

### Add LINQ to SQL in Visual Studio

1. Add new LINQ to SQL Classes file → name it ***TrainData.dbml***.
2. Drag `train_info` table and all stored procedures into the designer.
3. Save — it creates ***TrainDataDataContext***.

### traindata.aspx (UI)

```html
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="traindata.aspx.cs" Inherits="traindata" %>
<!DOCTYPE html>
<html>
    <body>
        <form runat="server">
            Train ID: 
            <asp:TextBox ID="txtID" runat="server" ReadOnly="true" />
            <br/>
            Name: 
            <asp:TextBox ID="txtName" runat="server" />
            <br/>
            Type: 
            <asp:TextBox ID="txtType" runat="server" />
            <br/>
            Arrival: 
            <asp:TextBox ID="txtArrival" runat="server" />
            <br/>
            Departure: 
            <asp:TextBox ID="txtDeparture" runat="server" />
            <br/>
            Start: 
            <asp:TextBox ID="txtStart" runat="server" />
            <br/>
            End: 
            <asp:TextBox ID="txtEnd" runat="server" />
            <br/>
            <asp:Button ID="btnInsert" runat="server" Text="Insert" OnClick="btnInsert_Click" />
            <asp:Button ID="btnUpdate" runat="server" Text="Update" OnClick="btnUpdate_Click" />
            <asp:Button ID="btnDelete" runat="server" Text="Delete" OnClick="btnDelete_Click" />
            <asp:TextBox ID="txtSearch" runat="server" />
            <asp:Button ID="btnSearch" runat="server" Text="Search" OnClick="btnSearch_Click" />
            <asp:Button ID="btnShow" runat="server" Text="Show All" OnClick="btnShow_Click" />
            <br/>
            <asp:GridView ID="GridView1" runat="server" AutoGenerateColumns="true" />
        </form>
    </body>
</html>
```

### traindata.aspx.cs (Code-behind)

```csharp
using System;
using System.Linq;

public partial class traindata: System.Web.UI.Page {
  TrainDataDataContext db = new TrainDataDataContext();

  protected void Page_Load(object sender, EventArgs e) {
    if (!IsPostBack) ShowAll();
  }

  void ShowAll() {
    GridView1.DataSource = db.sp_GetTrains();
    GridView1.DataBind();
  }

  protected void btnInsert_Click(object sender, EventArgs e) {
    db.sp_InsertTrain(txtName.Text, txtType.Text, TimeSpan.Parse(txtArrival.Text), TimeSpan.Parse(txtDeparture.Text), txtStart.Text, txtEnd.Text);
    ShowAll();
  }

  protected void btnUpdate_Click(object sender, EventArgs e) {
    db.sp_UpdateTrain(int.Parse(txtID.Text), txtName.Text, txtType.Text, TimeSpan.Parse(txtArrival.Text), TimeSpan.Parse(txtDeparture.Text), txtStart.Text, txtEnd.Text);
    ShowAll();
  }

  protected void btnDelete_Click(object sender, EventArgs e) {
    db.sp_DeleteTrain(int.Parse(txtID.Text));
    ShowAll();
  }

  protected void btnSearch_Click(object sender, EventArgs e) {
    GridView1.DataSource = db.sp_SearchTrain(txtSearch.Text);
    GridView1.DataBind();
  }

  protected void btnShow_Click(object sender, EventArgs e) {
    ShowAll();
  }
}
```
